generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// datasource db {
//   provider  = "postgresql"
//   url       = env("DATABASE_URL")
//   directUrl = env("DIRECT_URL")
// }

model User {
  id            String         @id
  name          String
  email         String
  emailVerified Boolean        @default(false)
  image         String?
  coverImage    String?
  description   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  level         String         @default("User")
  points        Int            @default(0)
  earnings      Float          @default(0)
  sessions      Session[]
  accounts      Account[]
  works         Work[]
  purchases     Purchase[]
  reviews       Review[]
  followers     Follow[]       @relation("UserFollowers")
  following     Follow[]       @relation("UserFollowing")
  workLikes     WorkLike[]
  workDislikes  WorkDislike[]
  playlists     Playlist[]
  watchHistory  WatchHistory[]

  // Stripe Subscription fields
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  userId    String
  token     String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// 应用特定模型

model Work {
  id              String   @id @default(uuid())
  title           String?
  description     String?
  price           Float?
  category        String?
  language        String?
  tags            String?
  quickPick       Boolean? @default(false)
  quickPickOrder  Int?
  fileUrl         String?
  thumbnailUrl    String?
  durationSeconds Int?
  status          String?
  isForKids       Boolean  @default(true)
  earnings        Float    @default(0)
  downloads       Int      @default(0)
  views           Int      @default(0)
  rating          Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 关联
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases       Purchase[]
  reviews         Review[]
  workLikes       WorkLike[]
  workDislikes    WorkDislike[]
  playlistEntries PlaylistEntry[]
  watchHistories  WatchHistory[]

  @@map("works")
}

model Purchase {
  id        String   @id @default(uuid())
  amount    Float
  createdAt DateTime @default(now())

  // 关联
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  workId String
  work   Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("purchases")
}

model Review {
  id        String   @id @default(uuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  workId String
  work   Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("reviews")
}

model Follow {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // 关联
  followerId  String
  followingId String
  follower    User   @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User   @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

// 作品关注（用户关注/收藏某作品）
model WorkLike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // 关联
  userId String
  workId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  work   Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("work_likes")
}

// 作品踩（用户不喜欢某作品）
model WorkDislike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // 关联
  userId String
  workId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  work   Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("work_dislikes")
}

// 播放列表（用户可以创建多个播放列表）
model Playlist {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联到用户
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 关联到播放列表条目
  entries PlaylistEntry[]

  @@map("playlists")
}

// 播放列表条目（指向具体作品）
model PlaylistEntry {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // 关联到播放列表
  playlistId String
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  // 关联到作品
  workId String
  work   Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  // 每个播放列表中同一作品只出现一次
  @@unique([playlistId, workId])
  @@map("playlist_entries")
}

// 观看历史（用户观看过的作品，每个用户每个作品保留单条记录，按最近观看时间更新）
model WatchHistory {
  id        String   @id @default(uuid())
  userId    String
  workId    String
  watchedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  work Work @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([userId, workId])
  @@map("watch_history")
}

model BetaApplication {
  id        String   @id @default(uuid())
  email     String   @unique
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("beta_applications")
}

model Event {
  id     String @id @default(uuid())
  title  String
  status String @default("Upcoming") // Upcoming, On viewing, Archive

  // Artist info
  artistName         String?
  artistAvatar       String?
  artistDetailName   String?
  artistDetailAvatar String?
  artistBirth        String?
  artistBio          String?

  // Event details
  period    String?
  location  String?
  posterUrl String?

  // Content
  introductionImageUrl   String?
  introductionVideoCover String?

  // Exhibition Info
  exhibitionName     String?
  exhibitionDuration String?
  exhibitionLocation String?
  exhibitionCurator  String?

  // Dates (stored as JSON string)
  dates String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("events")
}
